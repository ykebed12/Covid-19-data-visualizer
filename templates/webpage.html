<!DOCTYPE html>
<html>

<head>
	<!-- leaflet map stuff -->
	<link rel="stylesheet" href="{{ url_for('static', filename='./leaflet/leaflet.css') }}" />
	<script src="{{ url_for('static', filename='./leaflet/leaflet.js') }}"></script>
	<script src="{{ url_for('static', filename='./jquery-3.6.0.min.js') }}"></script>

	<!-- geojson file for counties -->
	<script src="{{ url_for('static', filename='./geojsonfiles/CaliforniaCounties.js') }}"></script>

	<!-- leaflet cluster for markers -->
	<link rel="stylesheet"
		href="{{ url_for('static', filename='./Leaflet.markercluster/dist/MarkerCluster.Default.css') }}" />
	<link rel="stylesheet" href="{{ url_for('static', filename='./Leaflet.markercluster/dist/MarkerCluster.css') }}" />
	<script
		src="{{ url_for('static', filename='./Leaflet.markercluster/dist/leaflet.markercluster-src.js') }}"></script>
	
	<!-- Javascript file for relevant functions -->
	<script src="{{ url_for('static', filename='./Functions.js') }}"></script>


	<style>
		#map {
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			background: lightblue;
		}

		#datePicker {
			position: absolute;
			height: 40px;
			top: 100px;
			bottom: 20px;
			padding: 10px;
			z-index: 1000;
		}
	</style>
</head>

<body>
	<input type="date" id="datePicker" onchange='county_handler(event);' min="{{ min_county_date }}"
		max="{{ max_county_date }}">

	<div id="map"></div>

	<script>
		var map = L.map('map', { maxZoom: 18, maxWidth: 100}).setView([0, 0], 1);
		var countiesData; // Contain most recent county data

		function highlightFeature(e) {
			var layer = e.target;

			layer.setStyle({
				weight: 2,
				color: "white",
				dashArray: '',
				fillOpacity: 1
			});

			if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
				layer.bringToFront();
			}
		}

		function resetHighlight(e) {
    		countiesLayer.resetStyle(e.target);

			var layer = e.target;
			var countyName = layer.feature.properties.name;
			if (countiesData && countiesData[countyName]) {
				
				var countyData = countiesData[countyName];

				layer.setStyle({
					fillColor: getColor(countyData["Cases"])
				});
			}

		}

		function zoomToFeature(e) {
    		map.fitBounds(e.target.getBounds());
			
		}

		// Function that will include the counts of cases and deaths in 
		function county_handler(e) {
			
			var date = e.target.value + " 00:00:00";
			//ajax calls to another webpage route to get counties data for date selected
			$.ajax({
				type: "GET",
				url: "/county_data/" + date,
				cache: false,
				success: function (data) {
					data = JSON.parse(data)
					countiesData = data
					countiesLayer.eachLayer(function (layer) {
						

						var countyName = layer.feature.properties.name
						var stateName = layer.feature.properties.state
						var countyData = data[countyName]


						
						var popupContent =
							"<p>State: " + stateName +
							"<br>County: " + countyName +
							"<br>Cases: " + countyData["Cases"] +
							"<br>Deaths: " + countyData["Deaths"] +
							"<br>Date: " + countyData["Closest_Date"] + "</p>";

						layer.bindPopup(popupContent)
						layer.setStyle({
							fillColor: getColor(countyData["Cases"])
						})
							
						
					})
				}
					
			})
		}

		//code for pop up before date selection
		function onEachFeature(feature, layer) {
			var popupContent = 
				"<p>State: " + feature.properties.state +
				"<br>County: " + feature.properties.name + "</p>";

			layer.bindPopup(popupContent);

			layer.on({
				mouseover: highlightFeature,
				mouseout: resetHighlight,
				click: zoomToFeature
			});
		}
		
		// Display county boundries
		var countiesLayer = L.geoJson(CaliforniaCounties, {
			onEachFeature: onEachFeature,
			style:{
				fillColor: "Coral",
				color: "white",
				fillOpacity: 1
			}
		}).addTo(map);

		map.fitBounds(countiesLayer.getBounds())
		map.options.minZoom = map._zoom
		map.setMaxBounds(countiesLayer.getBounds())
		

		

		// Add a pane to bring markers infront of map
		map.createPane('prisonMarkers');
		map.getPane('prisonMarkers').style.zIndex = 401;
		map.getPane('prisonMarkers').style.pointerEvents = 'none';

		//create marker cluster
		var markerCluster = L.markerClusterGroup({ chunkedLoading: true });

		// Make a marker for each facility in california
		{% for facility in facilities %}

		marker = L.circleMarker([{{ facility[5] }}, {{ facility[4] }}], {
			color: "White",
			fillColor: "Red",
			pane: "prisonMarkers",
			fillOpacity: 1
		})
		marker.bindPopup("Prison: {{facility[1]}} <br>Covid Cases: ")
		markerCluster.addLayer(marker);

		{% endfor %}

		map.addLayer(markerCluster);

	</script>
</body>

</html>